pipeline {
    agent any

    environment {
        // Définir les variables d'environnement pour SonarQube et les autres outils si nécessaire
        SONARQUBE_URL = 'http://your-sonarqube-url'
        SONARQUBE_TOKEN = 'your-sonarqube-token'
        MAVEN_REPO_URL = 'https://mymavenrepo.com/repo/wfeEoJVTqyCrSb3fpohC/'
        MAVEN_REPO_USERNAME = 'myMavenRepo'
        MAVEN_REPO_PASSWORD = '12345678'
    }

    stages {
        stage('Checkout') {
            steps {
                // Vérifie le code depuis le dépôt Git
                checkout scm
            }
        }

        stage('Test') {
            steps {
                // Exécuter les tests
                script {
                    // Si vous utilisez JUnit ou un autre framework de test
                    sh './gradlew test'
                }
            }
            post {
                always {
                    // Archiver les rapports de tests
                    junit '**/build/test-logs/*.xml'
                }
            }
        }

        stage('Code Analysis (SonarQube)') {
            steps {
                // Lancer l'analyse SonarQube
                script {
                    sh './gradlew sonarqube -Dsonar.login=${SONARQUBE_TOKEN}'
                }
            }
        }

        stage('Code Quality') {
            steps {
                script {
                    // Vérifier l'état du Quality Gate de SonarQube
                    def qualityGateStatus = sh(script: './gradlew sonarqube -Dsonar.login=${SONARQUBE_TOKEN} -Dsonar.qualitygate.wait=true', returnStatus: true)
                    if (qualityGateStatus != 0) {
                        currentBuild.result = 'FAILURE'
                        error "Quality Gate failed!"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                // Compiler et construire le projet (générer le JAR et la documentation)
                script {
                    sh './gradlew build generateJavadoc'
                }
            }
            post {
                success {
                    // Archivage du fichier JAR et de la documentation
                    archiveArtifacts artifacts: '**/build/libs/*.jar', allowEmptyArchive: true
                    archiveArtifacts artifacts: '**/build/docs/javadoc/**/*', allowEmptyArchive: true
                }
            }
        }

        stage('Deploy') {
            steps {
                // Déployer le fichier JAR dans le dépôt Maven
                script {
                    sh './gradlew publish'
                }
            }
        }

        stage('Notification') {
            steps {
                script {
                    // Envoyer des notifications Slack
                    slackSend (channel: '#your-channel', message: "Build and deploy completed successfully. Version: ${env.BUILD_TAG}")

                    // Envoyer un email en cas de succès
                    mail to: 'your-email@example.com', subject: "Build Success", body: "The build and deployment have been successfully completed!"
                }
            }
        }
    }

    post {
        failure {
            // Envoyer une notification Slack en cas d'échec
            slackSend (channel: '#your-channel', message: "Build or deploy failed. Please check the logs.")

            // Envoyer un email en cas d'échec
            mail to: 'your-email@example.com', subject: "Build Failure", body: "The build or deployment has failed. Please check the Jenkins logs for details."
        }
    }
}
